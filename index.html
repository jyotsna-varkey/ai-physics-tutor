<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Physics Tutor</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
const { useState, useEffect, useRef } = React;

// Icons
const Send = () => <svg width={20} height={20} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={2}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>;
const BookOpen = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={2}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>;
const CheckCircle = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={2}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>;
const XCircle = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={2}><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>;

// ========== CONCEPT MAP ==========
const CONCEPT_MAP = {
  "universal_law": { 
    name: "Universal Law of Gravitation", 
    formula: "F = G(Mm/d¬≤)",
    keyIdeas: [
      "Every object attracts every other object",
      "Force ‚àù product of masses",
      "Force ‚àù 1/(distance)¬≤"
    ]
  },
  "free_fall": { 
    name: "Free Fall", 
    keyIdeas: [
      "Objects fall under gravity alone",
      "All objects fall at same rate in vacuum"
    ]
  },
  "acceleration_gravity": { 
    name: "Acceleration due to Gravity", 
    formula: "g = GM/R¬≤",
    keyIdeas: [
      "g ‚âà 9.8 m/s¬≤",
      "Independent of object's mass"
    ]
  },
  "mass_weight": { 
    name: "Mass vs Weight", 
    formula: "W = mg",
    keyIdeas: [
      "Mass is constant",
      "Weight varies with location"
    ]
  },
  "thrust_pressure": { 
    name: "Thrust and Pressure", 
    formula: "P = F/A",
    keyIdeas: [
      "Pressure = Force/Area",
      "Smaller area = higher pressure"
    ]
  }
};

// ========== MCQ BANKS ==========
const DIAGNOSTIC_MCQs = {
  universal_law: {
    question: "What happens to gravitational force if you double the distance between two objects?",
    options: [
      { id: 'a', text: "Becomes half" },
      { id: 'b', text: "Becomes one-fourth" },
      { id: 'c', text: "Stays the same" },
      { id: 'd', text: "Becomes double" }
    ],
    correctAnswer: 'b',
    explanation: "Force ‚àù 1/d¬≤. If d doubles, force becomes 1/4."
  },
  free_fall: {
    question: "When you drop a ball, what causes it to fall?",
    options: [
      { id: 'a', text: "Air pushing it down" },
      { id: 'b', text: "Earth's gravitational force" },
      { id: 'c', text: "Ball's own weight only" },
      { id: 'd', text: "Natural tendency" }
    ],
    correctAnswer: 'b',
    explanation: "Earth's gravitational force pulls objects downward."
  },
  acceleration_gravity: {
    question: "A heavy ball and light ball drop in vacuum. Which hits ground first?",
    options: [
      { id: 'a', text: "Heavy ball" },
      { id: 'b', text: "Light ball" },
      { id: 'c', text: "Both at same time" },
      { id: 'd', text: "Depends on shape" }
    ],
    correctAnswer: 'c',
    explanation: "All objects fall at same rate in vacuum (g is independent of mass)."
  },
  mass_weight: {
    question: "Your mass is 50 kg on Earth. What is your mass on the Moon?",
    options: [
      { id: 'a', text: "50 kg" },
      { id: 'b', text: "About 8 kg" },
      { id: 'c', text: "300 kg" },
      { id: 'd', text: "Cannot determine" }
    ],
    correctAnswer: 'a',
    explanation: "Mass is constant everywhere. Weight changes, not mass."
  },
  thrust_pressure: {
    question: "Why does a nail have a pointed tip?",
    options: [
      { id: 'a', text: "To look sharp" },
      { id: 'b', text: "Small area increases pressure" },
      { id: 'c', text: "To increase force" },
      { id: 'd', text: "To reduce friction" }
    ],
    correctAnswer: 'b',
    explanation: "P = F/A. Smaller area means higher pressure for same force."
  }
};

const CONCEPT_MCQs = {
  universal_law: [
    {
      question: "If Earth's mass doubled but radius stayed same, gravitational force would:",
      options: ["Become half", "Stay same", "Double", "Become four times"],
      correct: 2,
      explanation: "F = GMm/r¬≤. If M doubles, F doubles."
    },
    {
      question: "Why don't you feel gravitational pull from your friend next to you?",
      options: [
        "No gravity between people",
        "Force too small due to small masses",
        "Cancelled by Earth's gravity",
        "Only Earth has gravity"
      ],
      correct: 1,
      explanation: "Force exists but negligible due to small masses."
    },
    {
      question: "Gravitational force acts in which direction?",
      options: ["Always downward", "Along line joining centers", "Perpendicular", "Random"],
      correct: 1,
      explanation: "Force acts along the line joining centers of masses."
    }
  ],
  acceleration_gravity: [
    {
      question: "Value of g on Earth's surface is approximately:",
      options: ["9.8 km/s¬≤", "9.8 m/s¬≤", "9.8 cm/s¬≤", "9.8 mm/s¬≤"],
      correct: 1,
      explanation: "g = 9.8 m/s¬≤ on Earth's surface."
    },
    {
      question: "The value of g depends on:",
      options: ["Mass of falling object", "Speed of object", "Mass and radius of Earth", "Drop height"],
      correct: 2,
      explanation: "g = GM/R¬≤ (Earth's mass and radius)."
    },
    {
      question: "If Earth's radius doubled (mass same), g becomes:",
      options: ["g/4", "g/2", "Same g", "2g"],
      correct: 0,
      explanation: "g ‚àù 1/R¬≤. If R doubles, g becomes g/4."
    }
  ],
  mass_weight: [
    {
      question: "SI unit of mass is ____ and weight is ____:",
      options: ["kg, kg", "N, N", "kg, N", "N, kg"],
      correct: 2,
      explanation: "Mass in kg, weight (force) in N."
    },
    {
      question: "Weight on Moon is about ____ of weight on Earth:",
      options: ["1/6", "1/2", "6 times", "Same"],
      correct: 0,
      explanation: "Moon's gravity ‚âà (1/6) of Earth's."
    },
    {
      question: "Object mass 10 kg. Weight on Earth (g=10 m/s¬≤):",
      options: ["10 N", "1 N", "100 N", "10 kg"],
      correct: 2,
      explanation: "W = mg = 10 √ó 10 = 100 N."
    }
  ]
};

const RAPID_FIRE = [
  { q: "Gravitational force exists between:", opts: ["Only planets", "Only Earth objects", "All objects", "Only large objects"], c: 2, t: 15 },
  { q: "Mass measured in:", opts: ["Newton", "Kilogram", "Meter", "Pascal"], c: 1, t: 10 },
  { q: "Value of g on Earth:", opts: ["9.8 m/s", "9.8 m/s¬≤", "9.8 kg", "9.8 N"], c: 1, t: 12 },
  { q: "Distance halved, force becomes:", opts: ["Half", "Double", "Four times", "One-fourth"], c: 2, t: 20 },
  { q: "Free fall means:", opts: ["No acceleration", "Constant velocity", "Constant acceleration", "Random"], c: 2, t: 18 },
  { q: "60 N on Earth weighs on Moon:", opts: ["60 N", "10 N", "360 N", "6 N"], c: 1, t: 20 },
  { q: "Increase pressure (same force):", opts: ["Increase area", "Decrease area", "Same area", "Change direction"], c: 1, t: 18 },
  { q: "Earth mass 4√ó, radius 2√ó, g becomes:", opts: ["Same", "2g", "g/2", "4g"], c: 0, t: 30 }
];

// ========== STUDENT MODEL ==========
class StudentModel {
  constructor() {
    this.mastery = {};
    this.diagnosticAnswers = {}; // Track diagnostic answers
  }

  setDiagnosticAnswer(conceptId, isCorrect) {
    this.diagnosticAnswers[conceptId] = isCorrect;
    if (isCorrect) {
      this.mastery[conceptId] = 1.0;
    } else {
      this.mastery[conceptId] = 0.0;
    }
  }

  updateMastery(conceptId, percentage) {
    if (!this.mastery[conceptId]) this.mastery[conceptId] = 0;
    
    if (percentage === 1.0) {
      this.mastery[conceptId] = Math.min(1.0, this.mastery[conceptId] + 0.30);
    } else if (percentage >= 0.66) {
      this.mastery[conceptId] = Math.min(1.0, this.mastery[conceptId] + 0.20);
    } else if (percentage >= 0.33) {
      this.mastery[conceptId] = Math.min(1.0, this.mastery[conceptId] + 0.10);
    } else {
      this.mastery[conceptId] = Math.max(0, this.mastery[conceptId] - 0.05);
    }
  }

  getMastery(conceptId) {
    return this.mastery[conceptId] || 0;
  }

  getLearningPath() {
    // Return concepts where diagnostic was wrong (or not taken)
    const allConcepts = Object.keys(CONCEPT_MAP);
    return allConcepts.filter(c => !this.diagnosticAnswers[c]);
  }
}

// ========== MAIN COMPONENT ==========
const IntegratedPhysicsTutor = () => {
  // Core state
  const [phase, setPhase] = useState('welcome');
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState('');
  const [loading, setLoading] = useState(false);
  
  // Diagnostic state
  const [diagnosticQueue, setDiagnosticQueue] = useState([]);
  const [currentDiagnosticIndex, setCurrentDiagnosticIndex] = useState(0);
  
  // Learning state  
  const [learningQueue, setLearningQueue] = useState([]);
  const [currentLearningIndex, setCurrentLearningIndex] = useState(0);
  const [inSocraticMode, setInSocraticMode] = useState(false);
  const [socraticCount, setSocraticCount] = useState(0);
  
  // Validation state
  const [inValidationMode, setInValidationMode] = useState(false);
  const [validationQueue, setValidationQueue] = useState([]);
  const [validationIndex, setValidationIndex] = useState(0);
  const [validationResults, setValidationResults] = useState([]);
  
  // MCQ display state
  const [currentMCQ, setCurrentMCQ] = useState(null);
  const [selectedOption, setSelectedOption] = useState(null);
  const [showExplanation, setShowExplanation] = useState(false);
  
  // Rapid fire state
  const [rapidFireIndex, setRapidFireIndex] = useState(0);
  const [rapidFireScore, setRapidFireScore] = useState(0);
  
  const studentModel = useRef(new StudentModel());
  const messagesEndRef = useRef(null);

  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [messages]);

  useEffect(() => {
    if (phase === 'welcome') {
      addMessage('assistant', 
        "# Welcome to Your Physics Tutor! üéì\n\n" +
        "I'll help you master **Gravitation** through:\n" +
        "1. Quick Diagnostic\n" +
        "2. Personalized Learning\n" +
        "3. Practice & Validation\n" +
        "4. Final Challenge\n\n" +
        "Ready?"
      );
    }
  }, []);

  const addMessage = (role, content) => {
    setMessages(prev => [...prev, { role, content, timestamp: Date.now() }]);
  };

  // ========== PHASE 1: DIAGNOSTICS ==========
  const startDiagnostics = () => {
    const concepts = Object.keys(CONCEPT_MAP);
    setDiagnosticQueue(concepts);
    setCurrentDiagnosticIndex(0);
    setPhase('diagnostic');
    
    addMessage('assistant', "## üìä Diagnostic Assessment\n\n5 quick questions to find your starting point.\n\n**Question 1 of 5**");
    
    setTimeout(() => {
      showDiagnosticQuestion(concepts[0]);
    }, 500);
  };

  const skipDiagnostics = () => {
    // Skip diagnostics - learn all concepts
    const allConcepts = Object.keys(CONCEPT_MAP);
    setLearningQueue(allConcepts);
    setPhase('learning');
    
    addMessage('assistant', "Starting with all concepts...");
    
    setTimeout(() => {
      startLearningConcept(0, allConcepts);
    }, 1000);
  };

  const showDiagnosticQuestion = (conceptId) => {
    const mcq = DIAGNOSTIC_MCQs[conceptId];
    setCurrentMCQ({
      ...mcq,
      conceptId,
      type: 'diagnostic'
    });
    setSelectedOption(null);
    setShowExplanation(false);
  };

  const handleDiagnosticSubmit = () => {
    if (!selectedOption) return;
    
    const isCorrect = selectedOption === currentMCQ.correctAnswer;
    setShowExplanation(true);
    
    // Store answer immediately in model
    studentModel.current.setDiagnosticAnswer(currentMCQ.conceptId, isCorrect);
    
    console.log('Diagnostic answer recorded:', {
      concept: currentMCQ.conceptId,
      correct: isCorrect,
      totalAnswered: Object.keys(studentModel.current.diagnosticAnswers).length
    });
  };

  const nextDiagnostic = () => {
    const nextIndex = currentDiagnosticIndex + 1;
    
    if (nextIndex < diagnosticQueue.length) {
      setCurrentDiagnosticIndex(nextIndex);
      addMessage('assistant', `**Question ${nextIndex + 1} of ${diagnosticQueue.length}**`);
      setTimeout(() => {
        showDiagnosticQuestion(diagnosticQueue[nextIndex]);
      }, 300);
    } else {
      finishDiagnostics();
    }
  };

  const finishDiagnostics = () => {
    const learningPath = studentModel.current.getLearningPath();
    const correctCount = diagnosticQueue.length - learningPath.length;
    
    console.log('Diagnostics finished:', {
      total: diagnosticQueue.length,
      correct: correctCount,
      learningPath: learningPath,
      learningPathLength: learningPath.length
    });
    
    setCurrentMCQ(null); // Clear MCQ
    
    if (learningPath.length === 0) {
      addMessage('assistant',
        `## üåü Perfect Score!\n\n` +
        `You got all ${diagnosticQueue.length} correct!\n\n` +
        `Skipping to final challenge...`
      );
      setTimeout(() => startRapidFire(), 2000);
      return;
    }
    
    setLearningQueue(learningPath);
    setCurrentLearningIndex(0);
    
    addMessage('assistant',
      `## üìà Diagnostic Complete!\n\n` +
      `Score: **${correctCount}/${diagnosticQueue.length}**\n\n` +
      `**Learning path:**\n` +
      learningPath.map((c, i) => `${i + 1}. ${CONCEPT_MAP[c].name}`).join('\n') +
      `\n\nStarting with ${CONCEPT_MAP[learningPath[0]].name}...`
    );
    
    setTimeout(() => {
      startLearningConcept(0, learningPath); // PASS THE PATH DIRECTLY
    }, 2000);
  };

  // ========== PHASE 2: LEARNING ==========
  const startLearningConcept = (index, queueOverride) => {
    const queue = queueOverride || learningQueue; // Use passed queue or state
    
    console.log('Starting learning concept:', { 
      index, 
      queueLength: queue.length,
      queue: queue 
    });
    
    if (index >= queue.length) {
      console.log('All concepts learned, starting rapid fire');
      startRapidFire();
      return;
    }
    
    const conceptId = queue[index];
    const concept = CONCEPT_MAP[conceptId];
    
    setPhase('learning');
    setCurrentLearningIndex(index);
    setInSocraticMode(true);
    setSocraticCount(0);
    setCurrentMCQ(null);
    
    // Update state for future calls
    if (queueOverride) {
      setLearningQueue(queueOverride);
    }
    
    addMessage('assistant',
      `## üéØ ${concept.name}\n\n` +
      `**Key ideas:**\n` +
      concept.keyIdeas.map(idea => `‚Ä¢ ${idea}`).join('\n')
    );
    
    setTimeout(() => {
      startSocraticDialogue(conceptId);
    }, 1500);
  };

  const startSocraticDialogue = (conceptId) => {
    const questions = {
      universal_law: "Why do you think objects fall down when you drop them?",
      acceleration_gravity: "A heavy ball and light ball drop in vacuum. Which hits ground first?",
      mass_weight: "If you go to the Moon, what happens to your mass? Your weight?",
      free_fall: "When you throw a ball up, it slows, stops, falls. What's happening?",
      thrust_pressure: "Why is walking in high heels harder on sand than in sandals?"
    };
    
    addMessage('assistant', 
      `üí≠ **Let's discuss...**\n\n${questions[conceptId] || "What do you know about this?"}`
    );
    
    console.log('Socratic mode activated, waiting for user input');
  };

  const handleSocraticInput = async () => {
    if (!input.trim() || loading) return;
    
    const userMsg = input.trim();
    addMessage('user', userMsg);
    setInput('');
    setLoading(true);
    
    const count = socraticCount + 1;
    setSocraticCount(count);
    
    try {
      const conceptId = learningQueue[currentLearningIndex];
      
      // First evaluate if the answer is correct
      const evaluation = await evaluateResponse(conceptId, userMsg);
      
      // Then get Socratic follow-up
      const response = await getSocraticResponse(conceptId, userMsg, count, evaluation);
      addMessage('assistant', response);
      
      if (count >= 5) {
        setTimeout(() => {
          setInSocraticMode(false);
          startValidation(conceptId);
        }, 2000);
      }
    } finally {
      setLoading(false);
    }
  };

  const evaluateResponse = async (conceptId, userMsg) => {
    const concept = CONCEPT_MAP[conceptId];
    
    console.log('üîç Calling /api/evaluate...');
    
    try {
      const response = await fetch('/api/evaluate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          conceptId,
          conceptName: concept.name,
          keyIdeas: concept.keyIdeas,
          userMessage: userMsg
        })
      });
      
      console.log('Evaluate response status:', response.status);
      
      const data = await response.json();
      console.log('Evaluate response data:', data);
      
      if (data.error) {
        console.error('API returned error:', data.error);
      }
      
      // Parse result
      const grade = data.result?.charAt(0) || 'B';
      return { grade, explanation: data.result?.substring(4) || 'Could not evaluate' };
    } catch (e) {
      console.error('‚ùå Evaluation error:', e);
      return { grade: 'B', explanation: 'Could not evaluate' };
    }
  };

  const getSocraticResponse = async (conceptId, userMsg, count, evaluation) => {
    const concept = CONCEPT_MAP[conceptId];
    
    console.log('üîç Calling /api/socratic...');
    
    try {
      const response = await fetch('/api/socratic', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          conceptId,
          conceptName: concept.name,
          keyIdeas: concept.keyIdeas,
          formula: concept.formula,
          userMessage: userMsg,
          evaluation,
          exchangeCount: count
        })
      });
      
      console.log('Socratic response status:', response.status);
      
      const data = await response.json();
      console.log('Socratic response data:', data);
      
      if (data.error) {
        console.error('API returned error:', data.error);
      }
      
      return data.response || (count < 5 
        ? "Let me ask this differently: Can you explain your reasoning?" 
        : "Let's test your understanding with some questions.");
    } catch (e) {
      console.error('‚ùå Socratic error:', e);
      return count < 5 
        ? "Let me ask this differently: Can you explain your reasoning?" 
        : "Let's test your understanding with some questions.";
    }
  };

  // ========== PHASE 3: VALIDATION ==========
  const startValidation = (conceptId) => {
    const questions = CONCEPT_MCQs[conceptId] || [];
    
    setInValidationMode(true);
    setValidationQueue(questions);
    setValidationIndex(0);
    setValidationResults([]);
    setCurrentMCQ(null);
    
    addMessage('assistant', `## ‚úÖ Validation\n\n3 questions on ${CONCEPT_MAP[conceptId].name}`);
    
    setTimeout(() => {
      showValidationQuestion(conceptId, 0);
    }, 1000);
  };

  const showValidationQuestion = (conceptId, index) => {
    const questions = CONCEPT_MCQs[conceptId];
    if (index >= questions.length) {
      finishValidation(conceptId);
      return;
    }
    
    const q = questions[index];
    setCurrentMCQ({
      question: q.question,
      options: q.options.map((text, i) => ({ 
        id: String.fromCharCode(97 + i), 
        text 
      })),
      correctAnswer: String.fromCharCode(97 + q.correct),
      explanation: q.explanation,
      conceptId,
      type: 'validation'
    });
    setSelectedOption(null);
    setShowExplanation(false);
  };

  const handleValidationSubmit = () => {
    if (!selectedOption) return;
    
    const isCorrect = selectedOption === currentMCQ.correctAnswer;
    setShowExplanation(true);
    setValidationResults(prev => [...prev, isCorrect]);
  };

  const nextValidation = () => {
    const nextIdx = validationIndex + 1;
    setValidationIndex(nextIdx);
    showValidationQuestion(currentMCQ.conceptId, nextIdx);
  };

  const finishValidation = (conceptId) => {
    const correct = validationResults.filter(Boolean).length;
    const total = validationResults.length;
    const pct = correct / total;
    
    studentModel.current.updateMastery(conceptId, pct);
    const mastery = studentModel.current.getMastery(conceptId);
    
    setInValidationMode(false);
    setCurrentMCQ(null);
    
    if (mastery >= 0.75) {
      addMessage('assistant',
        `‚úÖ **${correct}/${total} correct!**\nMastery: ${Math.round(mastery*100)}%\n\nConcept mastered!`
      );
      
      setTimeout(() => {
        const nextIdx = currentLearningIndex + 1;
        startLearningConcept(nextIdx, learningQueue); // Pass current queue
      }, 2000);
    } else {
      addMessage('assistant',
        `${correct}/${total} correct (${Math.round(pct*100)}%). Need 75%.\n\nLet's review...`
      );
      
      setTimeout(() => {
        setInSocraticMode(true);
        setSocraticCount(0);
        startSocraticDialogue(conceptId);
      }, 2000);
    }
  };

  // ========== PHASE 4: RAPID FIRE ==========
  const startRapidFire = () => {
    setPhase('rapid_fire');
    setRapidFireIndex(0);
    setRapidFireScore(0);
    setCurrentMCQ(null);
    
    addMessage('assistant',
      `## üî• RAPID FIRE!\n\n${RAPID_FIRE.length} quick questions.\nNeed 75% to pass (${Math.ceil(RAPID_FIRE.length * 0.75)}/${RAPID_FIRE.length})\n\nReady?`
    );
    
    setTimeout(() => showRapidFireQuestion(0), 2000);
  };

  const showRapidFireQuestion = (index) => {
    if (index >= RAPID_FIRE.length) {
      finishRapidFire();
      return;
    }
    
    const rf = RAPID_FIRE[index];
    setCurrentMCQ({
      question: rf.q,
      options: rf.opts.map((text, i) => ({ 
        id: String.fromCharCode(97 + i), 
        text 
      })),
      correctAnswer: String.fromCharCode(97 + rf.c),
      type: 'rapid_fire'
    });
    setSelectedOption(null);
    setShowExplanation(false);
  };

  const handleRapidFireSubmit = () => {
    if (!selectedOption) return;
    
    const isCorrect = selectedOption === currentMCQ.correctAnswer;
    setShowExplanation(true);
    
    if (isCorrect) {
      setRapidFireScore(prev => prev + 1);
    }
  };

  const nextRapidFire = () => {
    const nextIdx = rapidFireIndex + 1;
    setRapidFireIndex(nextIdx);
    showRapidFireQuestion(nextIdx);
  };

  const finishRapidFire = () => {
    const pct = Math.round((rapidFireScore / RAPID_FIRE.length) * 100);
    
    if (pct >= 75) {
      setPhase('completed');
      addMessage('assistant',
        `## üèÜ CONGRATULATIONS!\n\n` +
        `Rapid Fire: ${rapidFireScore}/${RAPID_FIRE.length} (${pct}%)\n\n` +
        `üéì Chapter completed!`
      );
    } else {
      addMessage('assistant',
        `Rapid Fire: ${rapidFireScore}/${RAPID_FIRE.length} (${pct}%)\nNeed 75%.\n\nReviewing...`
      );
      setTimeout(() => startLearningConcept(0), 2000);
    }
  };

  // ========== RENDER ==========
  return (
    <div className="flex flex-col h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
      {/* Header */}
      <div className="bg-white shadow-md p-4 border-b-4 border-indigo-500">
        <div className="max-w-4xl mx-auto flex items-center justify-between">
          <div className="flex items-center gap-3">
            <BookOpen className="w-8 h-8 text-indigo-600" />
            <div>
              <h1 className="text-2xl font-bold">Physics Tutor</h1>
              <p className="text-sm text-gray-600">Gravitation - Class 9</p>
            </div>
          </div>
          {phase !== 'welcome' && (
            <div className="text-right">
              <div className="text-xs text-gray-500">Phase</div>
              <div className="text-sm font-bold text-indigo-600">{phase}</div>
            </div>
          )}
        </div>
      </div>

      {/* Messages */}
      <div className="flex-1 overflow-y-auto p-4">
        <div className="max-w-4xl mx-auto space-y-4">
          {messages.map((msg, i) => (
            <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
              <div className={`max-w-[85%] p-4 rounded-2xl shadow-sm ${
                msg.role === 'user' 
                  ? 'bg-indigo-600 text-white rounded-br-none' 
                  : 'bg-white text-gray-800 rounded-bl-none'
              }`}>
                <div className="whitespace-pre-wrap">{msg.content}</div>
              </div>
            </div>
          ))}
          
          {/* MCQ Display */}
          {currentMCQ && (
            <div className="bg-white p-6 rounded-2xl shadow-lg border-2 border-indigo-200">
              <h3 className="text-lg font-semibold mb-4">{currentMCQ.question}</h3>
              
              <div className="space-y-2">
                {currentMCQ.options.map((opt) => (
                  <button
                    key={opt.id}
                    onClick={() => !showExplanation && setSelectedOption(opt.id)}
                    disabled={showExplanation}
                    className={`w-full p-3 text-left rounded-lg border-2 transition ${
                      showExplanation
                        ? opt.id === currentMCQ.correctAnswer
                          ? 'border-green-500 bg-green-50'
                          : opt.id === selectedOption
                          ? 'border-red-500 bg-red-50'
                          : 'border-gray-200 bg-gray-50'
                        : selectedOption === opt.id
                        ? 'border-indigo-500 bg-indigo-50'
                        : 'border-gray-300 hover:border-indigo-300'
                    }`}
                  >
                    <span className="font-medium">{opt.id.toUpperCase()}.</span> {opt.text}
                    {showExplanation && opt.id === currentMCQ.correctAnswer && (
                      <CheckCircle className="inline ml-2 w-5 h-5 text-green-600" />
                    )}
                  </button>
                ))}
              </div>
              
              {showExplanation && currentMCQ.explanation && (
                <div className="mt-4 p-4 bg-blue-50 rounded-lg">
                  <p className="text-sm"><strong>Explanation:</strong> {currentMCQ.explanation}</p>
                </div>
              )}
              
              {!showExplanation && selectedOption && (
                <button
                  onClick={() => {
                    if (currentMCQ.type === 'diagnostic') handleDiagnosticSubmit();
                    else if (currentMCQ.type === 'validation') handleValidationSubmit();
                    else if (currentMCQ.type === 'rapid_fire') handleRapidFireSubmit();
                  }}
                  className="mt-4 w-full py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                >
                  Submit
                </button>
              )}
              
              {showExplanation && (
                <button
                  onClick={() => {
                    if (currentMCQ.type === 'diagnostic') nextDiagnostic();
                    else if (currentMCQ.type === 'validation') nextValidation();
                    else if (currentMCQ.type === 'rapid_fire') nextRapidFire();
                  }}
                  className="mt-4 w-full py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                >
                  Next ‚Üí
                </button>
              )}
            </div>
          )}
          
          {loading && (
            <div className="flex justify-start">
              <div className="bg-white p-4 rounded-2xl shadow-sm">
                <div className="flex gap-1">
                  <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                  <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay:'150ms'}}></div>
                  <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay:'300ms'}}></div>
                </div>
              </div>
            </div>
          )}
          
          <div ref={messagesEndRef} />
        </div>
      </div>

      {/* Input */}
      <div className="bg-white border-t p-4 shadow-lg">
        <div className="max-w-4xl mx-auto">
          {phase === 'welcome' && (
            <div className="flex gap-3">
              <button
                onClick={startDiagnostics}
                className="flex-1 py-4 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 text-lg font-semibold"
              >
                Start Diagnostic ‚Üí
              </button>
              <button
                onClick={skipDiagnostics}
                className="py-4 px-6 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 text-lg font-semibold"
              >
                Skip
              </button>
            </div>
          )}
          
          {inSocraticMode && !currentMCQ && (
            <div className="flex gap-2">
              <input
                type="text"
                value={input}
                onChange={(e) => setInput(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && !e.shiftKey && handleSocraticInput()}
                placeholder="Type your answer..."
                className="flex-1 p-3 border-2 rounded-xl focus:border-indigo-500 focus:outline-none"
                disabled={loading}
              />
              <button
                onClick={handleSocraticInput}
                disabled={loading || !input.trim()}
                className="px-6 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 disabled:bg-gray-300"
              >
                <Send className="w-5 h-5" />
              </button>
            </div>
          )}
          
          {phase === 'completed' && (
            <button
              onClick={() => window.location.reload()}
              className="w-full py-4 bg-green-600 text-white rounded-xl hover:bg-green-700 text-lg font-semibold"
            >
              Start New Chapter ‚Üí
            </button>
          )}
        </div>
      </div>
    </div>
  );
};


const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<IntegratedPhysicsTutor />);
    </script>
</body>
</html>
